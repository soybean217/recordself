<!DOCTYPE html>
<html lang="en">
<head>
<script>
	//parameters
	var mServerUrl = "http://nowiamdoing.com/for-client/";
</script>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="author" content="FuMing">

<title>Login</title>
<!-- Bootstrap core CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<link rel="stylesheet" href="css/jquery.dataTables-1.10.7.css">
<link rel="stylesheet" href="css/bootstrap-datetimepicker.min.css">
<!-- JQUERY validate CSS -->
<link rel="stylesheet" href="css/screen.css">
<!-- close when release -->
<script src="js/debug.js"></script>

<script src="js/jquery-2.1.3.min.js"></script>
<script src="js/bootstrap-3.3.4.min.js"></script>
<script src="js/jquery.dataTables-1.10.7.min.js"></script>
<script src="js/jquery.validate.min.js"></script>
<script src="js/bootstrap-datetimepicker.min.js"></script>
<script src="js/BigInteger.min.js"></script>
<script src="js/inc-functions.js"></script>
<script src="js/local-db-parameters.js"></script>
<script src="cordova.js"></script>
<script src="SQLitePlugin.js"></script>
<script>
	if (navigator.language.substring(0, 3) == "zh-") {
		document.write("<script src='js/globalization-zh.js'><\/script>");
		document.write("<script src='js/messages_zh.min.js'><\/script>");
	} else {
		document.write("<script src='js/globalization-en.js'><\/script>");
	}
</script>

</head>

<body>
	<div class="container" id="divSignIn">
		<form class="form-signin" id="formSignIn" role="form">
			<h2 class="form-signin-heading">
				<script>
					document.write(globalization_sign_in);
				</script>
			</h2>
			<label for="inputEmail" class="sr-only">Email address</label> <input
				type="text" id="signInUserName" class="form-control"
				name="signInUserName" required autofocus> <label
				for="inputPassword" class="sr-only"><script>
					document.write(globalization_password);
				</script></label> <input name="signInPassword" type="password" id="signInPassword"
				class="form-control" required>
			<button class="btn btn-lg btn-primary btn-block" type="submit">
				<script>
					document.write(globalization_sign_in);
				</script>
			</button>
		</form>
	</div>
	<div class="container" id="divSignUp">
		<form class="form-signin" id="formSignUp" role="form">
			<h2 class="form-signin-heading">
				<script>
					document.write(globalization_sign_up);
				</script>
			</h2>
			<label for="inputEmail" class="sr-only"><script>
				document.write(globalization_username);
			</script> </label> <input type="text" id="signUpUserName" class="form-control"
				name="signUpUserName" placeholder="Username" autofocus> <label
				for="inputPassword" class="sr-only"><script>
					document.write(globalization_password);
				</script></label> <input name="signUpPassword" type="password" id="signUpPassword"
				class="form-control" placeholder="Password" required><input
				name="signUpConfirmPassword" type="password"
				id="signUpConfirmPassword" class="form-control"
				placeholder="Password" required>
			<button class="btn btn-lg btn-primary btn-block" type="submit"
				id="register">
				<script>
					document.write(globalization_sign_up);
				</script>
			</button>
			<button class="btn btn-lg btn-primary btn-block" type="button"
				id="signUpJumpToSignIn">
				<script>
					document.write(globalization_sign_in_exist);
				</script>
			</button>
		</form>
	</div>
	<div class="container" id="divRecord">
		<form class="form-record" id="formRecord" role="form">
			<h2 class="form-signin-heading">
				<script>
					document.write(globalization_begin);
				</script>
			</h2>
			<label for="inputEmail" class="sr-only"><script>
				document.write(globalization_username);
			</script> </label> <input type="text" id="recordEditTitle" class="form-control"
				name="recordEditTitle" autofocus> <input type="text"
				id="recordEditDetail" class="form-control" name="recordEditDetail"><input
				type="hidden" id="recordEditId" class="form-control"
				name="recordEditId">
			<div class="row" id="recordEditTimePicker">
				<script>
					document.write(globalization_begin_time);
				</script>
				:<input size="14" type="text" id="recordEditBeginTime"
					class="form_datetime">
				<script>
					document.write(globalization_end_time);
				</script>
				:<input size="14" type="text" id="recordEditEndTime"
					class="form_datetime">
			</div>
			<div class="row" id="recordEditButtonGroup">
				<div class="btn-group" role="group" aria-label="...">
					<button type="submit" class="btn btn-default">
						<script>
							document.write(globalization_update);
						</script>
					</button>
					<button type="button" class="btn btn-warning" id="recordEditDelete">
						<script>
							document.write(globalization_delete);
						</script>
					</button>
				</div>
			</div>
			<button class="btn btn-lg btn-primary btn-block" type="submit"
				id="recordEditAddNew">
				<script>
					document.write(globalization_begin);
				</script>
			</button>
		</form>
	</div>
	<div class="container" id="divDisplayRecordList">
		<table cellpadding="0" cellspacing="0" border="0" class="display"
			id="tableRecord"></table>
	</div>
	<div class="container" id="divMenuAfterSignIn">
		<a href="javascript:clearLocalDataForSignOut();"><script>
			document.write(globalization_sign_out);
		</script></a>
	</div>
	<script>
		var LIMIT_UPDATE_BATCH_SIZE = 100;
		var divArray = new Array();
		var databaseStatus = "empty";
		var mJsonMsg, mEditRecord, mLocalDbProcess, mLocalParameters, mDisplayData, mRecordDataSet, mTable, mNeedServerIdCount;
		var mLastSyncTime = (new Date()).valueOf();
		var mSyncStatus = 'stop';
		var mSyncTimeout = 60000;
		mLocalParameters = {};
		divArray.push($("#divSignIn"));
		divArray.push($("#divSignUp"));
		divArray.push($("#divRecord"));
		divArray.push($("#divDisplayRecordList"));
		divArray.push($("#divMenuAfterSignIn"));
		//divArray.sort();//if you manual sort it , can close it .
		$("#inputPassword").attr("placeholder", globalization_password);
		var db = openDatabase("my.db", '1.0.0', '', 65536);
		$(document).ready(function() {
			formSignUpFormInitial();
			divRecordFormInitial();
			divDisplayRecordListFromDb();
		});

		function divDisplayRecordListFromDb() {
			mTable = $('#tableRecord').DataTable({
				"data" : mRecordDataSet,
				"paging" : false,
				"ordering" : false,
				"info" : false,
				"searching" : false,
				"order" : [ [ 0, "desc" ] ],
				"columns" : [ {
					"title" : "Id"
				}, {
					"title" : globalization_title
				}, {
					"title" : globalization_detail
				}, {
					"title" : globalization_begin_time
				}, {
					"title" : globalization_end_time
				} ],
				"columnDefs" : [ {
					"targets" : [ 0 ],
					"visible" : false,
					"searchable" : false
				}, {
					"targets" : [ 2 ],
					"visible" : false,
				}, {
					"targets" : [ 4 ],
					"visible" : false,
				} ]
			});
			$('#tableRecord tbody').on('click', 'tr', function() {
				divRecordFormFill(mTable.row(this).data());
				location.hash = 'divRecord';
			});
			$("#recordEditDelete").click(function() {
				deleteRecordWithId();

			})
		}
		function deleteRecordWithId() {
			mLocalDbProcess = "deleteRecord";
			db.transaction(dbDeleteSingleRecord, errorCB);
		}
		function dbDeleteSingleRecord(tx) {
			tx
					.executeSql(
							"update local_records set state = -1 ,modifyStatus=1 where clientId = ?; ",
							[ $("#recordEditId").val() ]);
			queryRecordAndDisplay();
			divRecordFormNew();
		}
		function divRecordFormNew() {
			$("#recordEditButtonGroup").hide();
			$("#recordEditTimePicker").hide();
			$("#recordEditAddNew").show();
			$("#recordEditTitle").val(null);
			$("#recordEditId").val(null);
			$("#recordEditDetail").val(null);
			$(".form_datetime").datetimepicker({
				format : 'yyyy-mm-dd hh:ii',
				autoclose : 1,
				initialDate : new Date()
			});
		}

		function divRecordFormFill(row) {
			if (row == null) {
			} else {
				$("#recordEditTitle").val(row[1]);
				$("#recordEditDetail").val(row[2]);
				$("#recordEditId").val(row[0]);
				$("#recordEditBeginTime").val(row[3]);
				if (row[4] == "") {
					$("#recordEditEndTime").val(
							new Date().Format("yyyy-MM-dd hh:mm"));
				} else {
					$("#recordEditEndTime").val(row[4]);
				}
				$("#recordEditBeginTime").show();
				$("#recordEditEndTime").show();
				$("#recordEditButtonGroup").show();
				$("#recordEditTimePicker").show();
				$("#recordEditAddNew").hide();
			}
		}

		function divRecordFormInitial() {
			$("#formRecord").validate({
				rules : {
					recordEditTitle : {
						required : true
					}
				}
			});
			$("#formRecord").submit(function(e) {
				e.preventDefault();
				if ($("#formRecord").valid()) {
					mEditRecord = {
						title : $("#recordEditTitle").val(),
						detail : $("#recordEditDetail").val(),
						beginTimeInputString : $("#recordEditBeginTime").val(),
						endTimeInputString : $("#recordEditEndTime").val(),
						clientId : $("#recordEditId").val()
					};
					editRecordProcess();
				}
			});
		}

		function editRecordProcess() {
			if (mEditRecord != null) {
				if (mEditRecord.clientId > 0) {
					//update
					mLocalDbProcess = "updateRecord";
					db.transaction(dbUpdateSingleRecord, errorCB);
				} else {
					//insert
					mLocalDbProcess = "insertRecord";
					db.transaction(dbInsertSingleRecord, errorCB);
				}
			}
		}

		function queryRecordAndDisplay() {
			divControl("#divRecord", "#divDisplayRecordList",
					"#divMenuAfterSignIn");
			mLocalDbProcess = "queryRecordAndDisplay";
			db.transaction(dbQueryRecord, errorCB);
		}

		// form the query
		function dbQueryRecord(tx) {
			tx
					.executeSql(
							"SELECT clientId,serverId,title,detail,serverUpdateTime,modifyStatus,beginTime,endTime "
									+ " from local_records where userId=? "
									+ " and state<>-1 order by beginTime desc limit 0,20;",
							[ mLocalParameters['userId'] ], refreshDataView,
							errorCB);
		}

		// Display the results
		function refreshDataView(tx, results) {
			mDisplayData = {
				records : []
			};
			var mRow = [];
			mRecordDataSet = [];
			var len = results.rows.length;
			//alert("results.rows.length: " + results.rows.length);
			for (var i = 0; i < len; i++) { // loop as many times as there are row results
				//			mRecordDataSet[i][0] = results.rows.item(i).title;
				var mRow = [
						results.rows.item(i).clientId,
						results.rows.item(i).title,
						results.rows.item(i).detail,
						new Date(results.rows.item(i).beginTime)
								.Format("yyyy-MM-dd hh:mm"),
						results.rows.item(i).endTime == 0 ? "" : (new Date(
								results.rows.item(i).endTime)
								.Format("yyyy-MM-dd hh:mm")) ];
				mRecordDataSet[i] = mRow;
				var row = {};
				row.clientId = results.rows.item(i).clientId;
				row.serverId = results.rows.item(i).serverId;
				row.title = results.rows.item(i).title;
				row.serverUpdateTime = results.rows.item(i).serverUpdateTime;
				mDisplayData.records.push(row);
			}
			//mTable.fnClearTable();
			//mTable.fnAddData(mRecordDataSet);
			//mTable.fnUpdate();
			//mTable.rows.add(mRecordDataSet).draw();
			//mTable.fnDraw();

			mTable.clear();
			mTable.rows.add(mRecordDataSet);
			mTable.draw();

			var syncThread = new syncRecordServer();
		}

		function formSignUpFormInitial() {
			$("#formSignUp").validate({
				rules : {
					signUpUserName : {
						required : true,
						minlength : 1,
						maxlength : 31
					},
					signUpPassword : {
						required : true,
						minlength : 1,
						maxlength : 31
					},
					signUpConfirmPassword : {
						required : true,
						minlength : 1,
						maxlength : 31,
						equalTo : "#signUpPassword"
					}
				}
			});
			$("#formSignUp").submit(function(e) {
				e.preventDefault();
				if ($("#formSignUp").valid()) {
					signUpAjax(mServerUrl);
				}
			});
			$("#formSignIn").validate({
				rules : {
					signInUserName : {
						required : true,
						minlength : 1,
						maxlength : 31
					},
					signInPassword : {
						required : true,
						minlength : 1,
						maxlength : 31
					}
				}
			});
			$("#formSignIn").submit(function(e) {
				e.preventDefault();
				if ($("#formSignIn").valid()) {
					signInAjax(mServerUrl);
				}
			});
		}

		function signInAjax(serverUrl) {
			var oriData = {
				userName : $("#signInUserName").val(),
				password : $("#signInPassword").val()
			};
			$.ajax({
				type : "post",
				url : serverUrl + "sign-in.jsp",
				async : false,
				data : JSON.stringify(oriData),
				dataType : "json",
				success : function(msg) {
					if (msg.status == "success") {
						if (databaseStatus == "empty") {
							signInOrUpSuccess(msg, $("#signInUserName").val());
						} else {
							//
						}
					} else {
						ajaxGetNotSuccessMsg(msg);
					}
				},
				error : ajaxNetworkError
			});
		}
		function signUpAjax(serverUrl) {
			var oriData = {
				userName : $("#signUpUserName").val(),
				password : $("#signUpPassword").val()
			};
			$.ajax({
				type : "post",
				url : serverUrl + "sign-up.jsp",
				async : false,
				data : JSON.stringify(oriData),
				dataType : "json",
				success : function(msg) {
					if (msg.status == "success") {
						if (databaseStatus == "empty") {
							signInOrUpSuccess(msg, $("#signUpUserName").val());
						} else {
							//
						}
					} else {
						ajaxGetNotSuccessMsg(msg);
					}
				},
				error : ajaxNetworkError
			});
		}

		function signInOrUpSuccess(msg, password) {
			mJsonMsg = msg;
			mLocalParameters['userId'] = msg.data.userId;
			// insert account to local database 
			mLocalDbProcess = "insertLocalUserAccout";
			db.transaction(dbInsertAccountInfo(msg.data.userName, password),
					errorCB);
		}

		//test on chrome
		$(document).ready(function() {
			initial();
		});

		document.addEventListener("deviceready", onDeviceReady, false);
		function onDeviceReady() {
			db = window.sqlitePlugin.openDatabase({
				name : "my.db"
			});
			initial();
		}

		function initial() {
			initialDB();
			initialButton();
		}
		function initialButton() {
			$("#signUpJumpToSignIn").click(function() {
				//check form data
				divControl("#divSignIn");
			})
		}
		function initialDB() {
			mLocalDbProcess = "Initial DB";
			db.transaction(populateDB, errorCB, successCB);
		}
		// insert account info to local 
		function dbInsertAccountInfo(userName, password) {
			return function(tx) {
				//,$("#signUpUserName").val()
				tx
						.executeSql(
								'insert into local_system_parameters (title,detail) values (?,?)',
								[ "userName", userName ]);
				tx
						.executeSql(
								'insert into local_system_parameters (title,detail) values (?,?)',
								[ "userId", mJsonMsg.data.userId ]);
				tx
						.executeSql(
								'insert into local_system_parameters (title,detail) values (?,?)',
								[ "passwordEncrypted", MD5(password) ]);
				mLocalParameters['userName'] = userName;
				mLocalParameters['passwordEncrypted'] = MD5(password);
				queryRecordAndDisplay();
			}
		}

		function convertDateStringToLong(inputString) {
			if (isNaN((new Date(inputString)).valueOf())) {
				return (new Date()).valueOf();
			} else {
				return (new Date(inputString).valueOf());
			}
		}

		// update record to local 
		function dbUpdateSingleRecord(tx) {
			var recordBeginTimeLong = convertDateStringToLong(mEditRecord.beginTimeInputString);
			var recordEndTimeLong = convertDateStringToLong(mEditRecord.endTimeInputString);
			tx
					.executeSql(
							"update local_records set title = ? ,detail = ? ,beginTime = ? ,endTime=? ,modifyStatus=1 where clientId=?; ",
							[ mEditRecord.title, mEditRecord.detail,
									recordBeginTimeLong, recordEndTimeLong,
									mEditRecord.clientId ]);
			queryRecordAndDisplay();
			divRecordFormNew();
		}
		/**
		insert record to local
		 */
		function dbInsertSingleRecord(tx) {
			var recordBeginTimeLong = convertDateStringToLong(mEditRecord.beginTimeInputString);
			tx
					.executeSql(
							"insert into local_records (userId,title,detail,beginTime) values (?,?,?,?); ",
							[ mLocalParameters['userId'], mEditRecord.title,
									mEditRecord.detail, recordBeginTimeLong ]);
			queryRecordAndDisplay();
			divRecordFormNew();
		}
		/**
		create table
		 */
		function populateDB(tx) {
			//tx.executeSql('DROP TABLE IF EXISTS local_system_parameters');
			tx
					.executeSql('CREATE TABLE IF NOT EXISTS local_system_parameters (title text primary key, detail text)');
			//tx.executeSql('DROP TABLE IF EXISTS local_records');
			tx.executeSql('CREATE TABLE IF NOT EXISTS local_records ('
					+ 'clientId integer primary key,' + 'userId text,'
					+ 'serverId text UNIQUE,'
					+ 'title text not null,detail text,'
					+ 'beginTime integer default 0,'
					+ 'endTime integer default 0,' + 'state integer default 0,'
					+ 'serverUpdateTime integer default 0,'
					+ 'modifyStatus integer default 1 )');
			checkParametersForInitial(tx);
		}

		function clearLocalDataForSignOut() {
			db.transaction(dbClearLocalDataForSignOut, errorCB);
			databaseStatus = "empty";
			divControl("#divSignUp");
		}
		function dbClearLocalDataForSignOut(tx) {
			tx.executeSql('delete from local_system_parameters;');
		}
		// form the query
		function checkParametersForInitial(tx) {
			mLocalDbProcess = "Get initial parameter";
			tx.executeSql("SELECT title,detail from local_system_parameters ;",
					[], callbackInitialParameters, errorCB);
		}
		// Display the results
		function callbackInitialParameters(tx, results) {
			var len = results.rows.length;
			if (len == 0) {
				//enter register or local use
				divControl("#divSignUp");
			} else {
				for (var i = 0; i < len; i++) { // loop as many times as there are row results
					mLocalParameters[results.rows.item(i).title] = results.rows
							.item(i).detail;
				}
				divRecordFormNew();
				//list record
				databaseStatus = "exist";
				queryRecordAndDisplay();
			}
		}
		// only accept sorted argument!
		function divControl() {
			var i = 0, numargs = arguments.length;
			//close all div
			var argArray = arguments;
			divArray.forEach(function(elem, index, arr) {
				elem.hide();
				//you can optimize here from last index, if arguments is sorted .
				for (i = 0; i < numargs; i++) {
					//					if (elem.selector == arguments[i].selector) {
					if (elem.selector == argArray[i]) {
						elem.show();
						break;
					}
				}
			});
		}
		// Transaction error callback
		function errorCB(err) {
			alert("errorCB:" + err.code + " as:" + mLocalDbProcess);
			console.log("Error processing SQL: " + err.code + " : "
					+ err.message);
		}
		// Success callback
		function successCB() {
		}

		var syncRecordServer = function() {
			console.log("mSyncStatus:" + mSyncStatus + " "
					+ ((new Date()).valueOf() - mLastSyncTime));
			if (mSyncStatus == 'stop'
					|| ((new Date()).valueOf() - mLastSyncTime > mSyncTimeout)) {
				console.log("begin sync");
				mSyncStatus = 'work';
				mLastSyncTime = (new Date()).valueOf();
				var needSyncCount = 0;
				var currentServerId = bigInt(0);

				procServerIdFromServer();
				//syncLocalToServer();
			}

			function syncLocalToServer() {
				db.transaction(dbLastSyncTime, errorCB);
			}

			function dbLastSyncTime(tx) {
				mLocalDbProcess = "dbLastSyncTime";
				tx
						.executeSql(
								"Select serverUpdateTime from local_records where userId=? order by serverUpdateTime desc limit 1 ;",
								[ mLocalParameters['userId'] ],
								handlerLastSyncTime, errorCB);
			}

			function handlerLastSyncTime(tx, results) {

				if (results.rows.length > 0) {
					if (results.rows.item(0).serverUpdateTime > 0) {
						withInputGetNeedSyncRecords(results.rows.item(0).serverUpdateTime);
					} else {
						withInputGetNeedSyncRecords(0);
					}
				} else {
					withInputGetNeedSyncRecords(0);
				}
			}

			function withInputGetNeedSyncRecords(lastServerTime) {
				db.transaction(withInputDbGetNeedSyncRecords(lastServerTime),
						errorCB);
			}

			function withInputDbGetNeedSyncRecords(lastServerTime) {
				return function dbGetNeedSyncRecords(tx) {
					mLocalDbProcess = "dbGetNeedSyncRecords";
					tx
							.executeSql(
									"Select serverId,title,detail,beginTime,endTime,state,serverUpdateTime "
											+ " from local_records where userId=? "
											+ "and serverId>0 and modifyStatus = 1 order by clientId limit ? ;",
									[ mLocalParameters['userId'],
											LIMIT_UPDATE_BATCH_SIZE ],
									withInputHandlerSyncRecordToServer(lastServerTime),
									errorCB);
				}
			}

			function withInputHandlerSyncRecordToServer(lastServerTime) {
				return function handlerSyncRecordToServer(tx, results) {
					var syncData = {
						records : [],
						lastSyncServerTimeFromClient : lastServerTime,
						clientParameters : mLocalParameters
					};
					for (var i = 0; i < results.rows.length; i++) {
						var row = {};
						console.log(results.rows.item(i).title);
						row.serverId = results.rows.item(i).serverId;
						row.title = results.rows.item(i).title;
						row.detail = results.rows.item(i).detail;
						row.beginTime = results.rows.item(i).beginTime;
						row.endTime = results.rows.item(i).endTime;
						row.state = results.rows.item(i).state;
						row.serverUpdateTime = results.rows.item(i).serverUpdateTime;
						syncData.records.push(row);
					}
					syncRecordAjax(mServerUrl, receiveSyncRecordRspAjax,
							ajaxGetNotSuccessMsg, ajaxNetworkError, syncData);
				}
			}

			function syncRecordAjax(serverUrl, successAjaxProc, errorRsp,
					ajaxNetworkError, syncData) {
				$.ajax({
					type : "post",
					url : serverUrl + "sync-record.jsp",
					async : false,
					data : JSON.stringify(syncData),
					dataType : "json",
					success : function(msg) {
						if (msg.status == "success") {
							successAjaxProc(msg);
						} else {
							errorRsp(msg);
						}
					},
					error : ajaxNetworkError
				});
			}

			function procServerIdFromServer() {
				db.transaction(dbGetCountNeedServerId, errorCB);
			}

			function dbGetCountNeedServerId(tx) {
				tx
						.executeSql(
								"SELECT count(clientId) as total from local_records where userId=? and serverId is null ;",
								[ mLocalParameters['userId'] ],
								handlerGetCountNeedServerId, errorCB);
			}

			function handlerGetCountNeedServerId(tx, results) {
				if (results.rows.length > 0) {
					if (results.rows.item(0).total > 0) {
						if (results.rows.item(0).total > LIMIT_UPDATE_BATCH_SIZE) {
							needSyncCount = LIMIT_UPDATE_BATCH_SIZE;
						} else {
							needSyncCount = results.rows.item(0).total;
						}
						getServerIdAjax(mServerUrl, receiveGetServerIdAjax,
								ajaxGetNotSuccessMsg, ajaxNetworkError,
								needSyncCount, "server_records");
					} else {
						//todo no result ;
						console
								.log("handlerGetCountNeedServerId:no record need get serverId .");
						syncLocalToServer();
					}
				} else {
					//todo no result ;
					console.log("error ! handlerGetCountNeedServerId");
				}
			}

			function receiveSyncRecordRspAjax(msg) {
				for (var i = 0; i < msg.data.length; i++) {
					if (msg.data[i].serverId.length > 1) {
						db.transaction(dbProcReceivedRecord(msg.data[i]),
								errorCB);
					}
				}
				mSyncStatus = 'stop';
			}
			function dbProcReceivedRecord(receiveRecord) {
				return function(tx) {
					tx
							.executeSql(
									"SELECT 1 from `local_records` where serverId=? and userId=? ;",
									[ receiveRecord.serverId,
											mLocalParameters['userId'] ],
									updateOrInsertReceivedRecord(receiveRecord),
									errorCB);
				}
			}
			function updateOrInsertReceivedRecord(receiveRecord) {
				return function(tx, results) {
					if (results.rows.length > 0) {
						tx
								.executeSql(
										"update local_records set title = ? ,detail = ? ,beginTime = ? ,endTime=?,"
												+ "state=? ,serverUpdateTime=?,modifyStatus=0 where serverId=?; ",
										[ receiveRecord.title,
												receiveRecord.detail,
												receiveRecord.beginTime,
												receiveRecord.endTime,
												receiveRecord.state,
												receiveRecord.serverUpdateTime,
												receiveRecord.serverId ]);
					} else {
						tx
								.executeSql(
										"insert into local_records (userId,title,detail,beginTime,endTime,state,serverUpdateTime,modifyStatus,serverId) values (?,?,?,?,?,?,?,0,?); ",
										[ mLocalParameters['userId'],
												receiveRecord.title,
												receiveRecord.detail,
												receiveRecord.beginTime,
												receiveRecord.endTime,
												receiveRecord.state,
												receiveRecord.serverUpdateTime,
												receiveRecord.serverId ]);
					}
				}
			}

			function receiveGetServerIdAjax(msg, count) {
				currentServerId = bigInt(msg.data);
				needSyncCount = count;
				if (currentServerId > 0) {
					db.transaction(dbProcRowNeedServerId, errorCB);
				}
			}

			function dbProcRowNeedServerId(tx) {
				tx
						.executeSql(
								"SELECT clientId from local_records where userId=? and serverId is null order by clientId limit ? ;",
								[ mLocalParameters['userId'], needSyncCount ],
								handlerUpdateClientServerId, errorCB);
			}
			function handlerUpdateClientServerId(tx, results) {
				if (results.rows.length > 0) {
					//getTransaction(iWork, results, currentServerId);
					db.transaction(iWork(results, currentServerId), errorCB)
					syncLocalToServer();
				} else {
					//todo no result ;
					console.log("handlerUpdateClientServerId: no rows .");
				}
			}

			function iWork(resultOfClientID, serverId) {
				return function(tx) {
					for (var i = 0; i < resultOfClientID.rows.length; i++) {
						tx
								.executeSql(
										"update local_records set serverId=? where clientId = ?; ",
										[
												serverId.toString(),
												resultOfClientID.rows.item(i).clientId ]);
						serverId = serverId.add(1);
					}
				}
			}

			function getServerIdAjax(serverUrl, successGetServerIdAjaxProc,
					errorRsp, ajaxNetworkError, needCount, tableName) {
				var oriData = {
					amount : needCount,
					keyTitle : tableName
				};
				$.ajax({
					type : "post",
					url : serverUrl + "get-server-id.jsp",
					async : false,
					data : JSON.stringify(oriData),
					dataType : "json",
					success : function(msg) {
						if (msg.status == "success") {
							successGetServerIdAjaxProc(msg, needCount);
						} else {
							errorRsp(msg);
						}
					},
					error : ajaxNetworkError
				});
			}

		}

		function ajaxGetNotSuccessMsg(msg) {
			console.log("ajaxGetNotSuccessMsg:" + msg.status + "-" + msg.msg);
			alert("ajaxGetNotSuccessMsg:" + msg.status + "-" + msg.msg);
		}

		function ajaxNetworkError(XMLHttpRequest, textStatus, errorThrown) {
			//alert("ajaxNetworkError:" + XMLHttpRequest.status + "-"	+ XMLHttpRequest.readyState + "-" + textStatus);
			console.log("ajaxNetworkError:" + XMLHttpRequest.status + "-"
					+ XMLHttpRequest.readyState + "-" + textStatus);
		}

		initialAttribute()
		function initialAttribute() {
			$("#signInUserName").attr("placeholder", globalization_username);
			$("#signInPassword").attr("placeholder", globalization_password);
			$("#signUpUserName").attr("placeholder", globalization_username);
			$("#signUpPassword").attr("placeholder", globalization_password);
			$("#recordEditTitle").attr("placeholder", globalization_title);
			$("#recordEditDetail").attr("placeholder", globalization_detail);
			$("#signUpConfirmPassword").attr("placeholder",
					globalization_confirm_password);
		}
	</script>
</body>
</html>
